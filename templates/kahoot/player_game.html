{% extends 'kahoot/base.html' %}

{% block title %}Kahoot - O'yin{% endblock %}

{% block extra_css %}
<style>
    .player-game-wrap {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        padding: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
    }
    .player-question-text {
        font-size: 1.35rem;
        line-height: 1.4;
        color: var(--text-light);
        text-align: center;
        min-height: 3em;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 16px;
    }
    .player-question-text.neon-text {
        color: #b8ff9e;
        text-shadow: 0 0 14px rgba(184, 255, 158, 0.9), 0 0 28px rgba(184, 255, 158, 0.6), 0 0 40px rgba(184, 255, 158, 0.3);
    }
    .player-timer-wrap {
        margin: 10px 0;
    }
    .player-timer {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: rgba(0,0,0,0.3);
        border: 5px solid rgba(255, 250, 205, 0.6);
        box-shadow: 0 0 25px rgba(255, 250, 205, 0.4), inset 0 0 20px rgba(0,0,0,0.25);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3.5rem;
        font-weight: 800;
        color: #fffacd;
        text-shadow: 0 0 20px rgba(255, 250, 205, 1), 0 0 40px rgba(255, 250, 205, 0.6);
        font-variant-numeric: tabular-nums;
    }
    .player-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        width: 100%;
        max-width: 560px;
        padding: 8px 0;
    }
    .player-btn {
        min-height: 88px;
        border-radius: 14px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px 20px;
        font-size: 1.1rem;
        font-weight: 700;
        color: #fff;
        text-align: center;
        transition: all 0.15s ease;
        box-shadow: 0 4px 0 rgba(0,0,0,0.25);
        position: relative;
    }
    .player-btn .btn-icon { font-size: 1.8rem; margin-right: 10px; flex-shrink: 0; }
    .player-btn .btn-label { flex: 1; line-height: 1.25; text-align: center; }
    .player-btn.btn-red {
        background: var(--kahoot-red);
        box-shadow: 0 4px 0 #a01328, 0 0 22px rgba(226, 27, 60, 0.5);
    }
    .player-btn.btn-blue {
        background: var(--kahoot-blue);
        box-shadow: 0 4px 0 #0d4a9e, 0 0 22px rgba(19, 104, 206, 0.5);
    }
    .player-btn.btn-yellow {
        background: var(--kahoot-yellow);
        box-shadow: 0 4px 0 #a87700, 0 0 22px rgba(216, 158, 0, 0.5);
    }
    .player-btn.btn-green {
        background: var(--kahoot-green);
        box-shadow: 0 4px 0 #1a6008, 0 0 22px rgba(38, 137, 12, 0.5);
    }
    .player-btn:hover:not(.disabled) {
        filter: brightness(1.08);
        box-shadow: 0 0 28px currentColor;
    }
    .player-btn:active:not(.disabled) {
        transform: translateY(2px);
        box-shadow: 0 2px 0 rgba(0,0,0,0.3);
    }
    .player-btn.disabled {
        opacity: 0.6;
        pointer-events: none;
    }
    .player-btn.correct-glow {
        box-shadow: 0 0 25px rgba(255,255,255,0.8), 0 0 40px rgba(184, 255, 158, 0.6);
        animation: correctPulse 0.5s ease;
    }
    .player-btn.incorrect-glow {
        box-shadow: 0 0 25px rgba(255,100,100,0.8);
        animation: incorrectShake 0.4s ease;
    }
    .player-status-bar {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 20px;
        background: rgba(0,0,0,0.25);
        border-radius: 10px;
        margin-bottom: 16px;
        font-weight: 600;
        color: rgba(255,255,255,0.95);
    }
    .player-status-bar #player-score {
        font-weight: 700;
        color: #fffacd;
        text-shadow: 0 0 10px rgba(255, 250, 205, 0.4);
    }
    @keyframes correctPulse {
        0%, 100% { filter: brightness(1); }
        50% { filter: brightness(1.3); }
    }
    @keyframes incorrectShake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-4px); }
        75% { transform: translateX(4px); }
    }
    .player-question-image-neon {
        display: inline-block;
        padding: 6px;
        border-radius: 12px;
        border: 2px solid rgba(184, 255, 158, 0.5);
        box-shadow: 0 0 20px rgba(184, 255, 158, 0.4);
    }
    .player-question-image-neon img {
        max-width: 220px;
        width: 100%;
        border-radius: 8px;
        display: block;
    }
    .on-fire-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 200;
        animation: onFireFade 2.5s ease forwards;
    }
    .on-fire-text {
        font-size: 3rem;
        font-weight: 800;
        color: #ff6b35;
        text-shadow: 0 0 20px #ff6b35, 0 0 40px #ff4500, 0 0 60px rgba(255,107,53,0.8);
        animation: onFirePulse 0.5s ease infinite alternate;
    }
    @keyframes onFireFade {
        0% { opacity: 0; }
        15% { opacity: 1; }
        85% { opacity: 1; }
        100% { opacity: 0; pointer-events: none; }
    }
    @keyframes onFirePulse {
        from { transform: scale(1); }
        to { transform: scale(1.08); }
    }
    .connection-status {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        z-index: 100;
        display: none;
    }
    .connection-status.connecting {
        display: block;
        background: rgba(255, 193, 7, 0.9);
        color: #000;
    }
    .connection-status.connected {
        display: block;
        background: rgba(76, 175, 80, 0.9);
        color: #fff;
    }
    .connection-status.disconnected {
        display: block;
        background: rgba(244, 67, 54, 0.9);
        color: #fff;
    }
</style>
{% endblock %}

{% block content %}
<div class="kahoot-container" style="padding: 10px;">
    <div id="connection-status" class="connection-status connecting">Ulanmoqda...</div>
    
    <div id="status-bar" class="player-status-bar">
        <span id="player-name">{{ player.nickname }}</span>
        <span id="player-score">{{ player.score }} ball</span>
    </div>

    <div class="player-game-wrap">
        <div id="waiting-state">
            <div class="player-timer-wrap">
                <div class="player-timer" id="timer">--</div>
            </div>
            <p class="player-question-text">Savol ko'rsatilmoqda...</p>
        </div>

        <div id="game-state" style="display: none; width: 100%;">
            <p class="player-question-text neon-text" id="question-text"></p>
            <div id="question-image-wrap" class="player-question-image-neon" style="display: none; margin: 8px auto;">
                <img id="question-image" src="" alt="">
            </div>
            <div class="player-timer-wrap">
                <div class="player-timer" id="timer-active"></div>
            </div>
            <div class="player-buttons" id="game-buttons">
                <button type="button" class="player-btn btn-red" data-option="A" onclick="submitAnswer('A')">
                    <span class="btn-icon">‚ñ≤</span>
                    <span class="btn-label" id="option-a"></span>
                </button>
                <button type="button" class="player-btn btn-blue" data-option="B" onclick="submitAnswer('B')">
                    <span class="btn-icon">‚óÜ</span>
                    <span class="btn-label" id="option-b"></span>
                </button>
                <button type="button" class="player-btn btn-yellow" data-option="C" onclick="submitAnswer('C')">
                    <span class="btn-icon">‚óè</span>
                    <span class="btn-label" id="option-c"></span>
                </button>
                <button type="button" class="player-btn btn-green" data-option="D" onclick="submitAnswer('D')">
                    <span class="btn-icon">‚ñ†</span>
                    <span class="btn-label" id="option-d"></span>
                </button>
            </div>
        </div>
    </div>

    <div id="feedback" class="feedback" style="display: none;"></div>

    <audio id="bg-music" loop preload="auto" style="display:none" volume="0.25"></audio>

    <div id="on-fire-overlay" class="on-fire-overlay" style="display: none;">
        <div class="on-fire-text">On Fire! üî•</div>
    </div>

    <div id="podium-container" style="display: none; text-align: center;">
        <h2 style="font-size: 2rem; margin-bottom: 30px; color: #fffacd; text-shadow: 0 0 20px rgba(255,250,205,0.7);">üèÜ Natijalar</h2>
        <div class="podium" id="podium"></div>
        <a href="/kahoot/join/" class="kahoot-btn kahoot-btn-primary" style="margin-top: 40px; display: inline-block; text-decoration: none; width: auto; padding: 16px 40px;">
            Yangi o'yin
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const pin = '{{ pin }}';
    const playerId = {{ player.id }};
    let ws = null;
    let currentQuestion = null;
    let questionStartTime = null;
    let hasAnswered = false;
    let totalScore = {{ player.score }};
    let timerInterval = null;
    let consecutiveCorrect = 0;
    let reconnectAttempts = 0;
    let maxReconnectAttempts = 5;
    let reconnectDelay = 2000;

    function initWebSocket() {
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        ws = new WebSocket(wsProtocol + '//' + window.location.host + '/ws/kahoot/' + pin + '/');

        ws.onopen = function() {
            console.log('WebSocket connected');
            updateConnectionStatus('connected');
            reconnectAttempts = 0;
            
            // Avval player_join yuborish
            ws.send(JSON.stringify({
                action: 'player_join',
                player_id: playerId,
                nickname: '{{ player.nickname|escapejs }}',
                avatar_id: {{ player.avatar_id }},
            }));
            
            // Keyin player_ready yuborish (state sync uchun)
            setTimeout(function() {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ 
                        action: 'player_ready', 
                        player_id: playerId 
                    }));
                }
            }, 500);
        };

        ws.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log('Received:', data.type, data);

            if (data.type === 'sync_current_state') {
                // State sinxronizatsiya
                handleStateSync(data);
            } else if (data.type === 'show_question') {
                if (data.question && (data.question.text || data.question.options)) {
                    showQuestion(data.question);
                } else {
                    showWaitingState();
                }
            } else if (data.type === 'answer_result') {
                showFeedback(data);
            } else if (data.type === 'question_results') {
                showWaitingState();
            } else if (data.type === 'game_ended') {
                showPodium(data.podium);
            }
        };

        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
            updateConnectionStatus('disconnected');
        };

        ws.onclose = function(e) {
            console.log('WebSocket closed:', e.code, e.reason);
            updateConnectionStatus('disconnected');
            
            // Avtomatik qayta ulanish
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                console.log('Reconnecting... Attempt', reconnectAttempts);
                updateConnectionStatus('connecting');
                setTimeout(initWebSocket, reconnectDelay);
            } else {
                alert('Aloqa uzildi. Sahifani yangilang.');
            }
        };
    }

    function updateConnectionStatus(status) {
        const statusEl = document.getElementById('connection-status');
        statusEl.className = 'connection-status ' + status;
        
        if (status === 'connected') {
            statusEl.textContent = '‚úì Ulandi';
            setTimeout(function() {
                statusEl.style.display = 'none';
            }, 2000);
        } else if (status === 'connecting') {
            statusEl.textContent = 'Ulanmoqda...';
            statusEl.style.display = 'block';
        } else if (status === 'disconnected') {
            statusEl.textContent = '‚úó Aloqa uzildi';
            statusEl.style.display = 'block';
        }
    }

    function handleStateSync(data) {
        console.log('State sync:', data);
        
        // Scoreni yangilash
        if (data.current_score !== undefined) {
            totalScore = data.current_score;
            document.getElementById('player-score').textContent = totalScore + ' ball';
        }
        
        // Agar o'yin davom etayotgan bo'lsa va savol mavjud bo'lsa
        if (data.status === 'PLAYING' && data.question) {
            // Agar allaqachon javob berilgan bo'lsa
            if (data.question.has_answered) {
                showWaitingState();
                document.getElementById('question-text').textContent = 'Siz bu savolga javob bergansiz. Keyingi savolni kuting...';
            } else {
                // Savolni ko'rsatish
                showQuestion(data.question);
            }
        } else if (data.status === 'FINISHED') {
            // O'yin tugagan
            window.location.href = '/kahoot/play/' + pin + '/podium/';
        }
    }

    function showWaitingState() {
        document.getElementById('waiting-state').style.display = 'block';
        document.getElementById('game-state').style.display = 'none';
        document.getElementById('timer').textContent = '--';
        document.getElementById('feedback').style.display = 'none';
    }

    function showQuestion(question) {
        currentQuestion = question || {};
        questionStartTime = Date.now();
        hasAnswered = false;

        const opts = question.options || {};
        const text = question.text || 'Savol...';
        const timeLimit = parseInt(question.time_limit, 10) || 20;

        document.getElementById('waiting-state').style.display = 'none';
        document.getElementById('game-state').style.display = 'block';
        document.getElementById('feedback').style.display = 'none';

        const bgMusic = document.getElementById('bg-music');
        if (bgMusic && bgMusic.src) {
            bgMusic.volume = 0.25;
            bgMusic.play().catch(function() {});
        }

        document.getElementById('question-text').textContent = text;
        const imgWrap = document.getElementById('question-image-wrap');
        if (question.image) {
            document.getElementById('question-image').src = question.image;
            imgWrap.style.display = 'block';
        } else {
            imgWrap.style.display = 'none';
        }
        document.getElementById('option-a').textContent = opts.A || 'A';
        document.getElementById('option-b').textContent = opts.B || 'B';
        document.getElementById('option-c').textContent = opts.C || 'C';
        document.getElementById('option-d').textContent = opts.D || 'D';

        document.querySelectorAll('.player-btn').forEach(function(btn) {
            btn.classList.remove('disabled', 'correct-glow', 'incorrect-glow');
        });

        const timerEl = document.getElementById('timer-active');
        let remaining = timeLimit;
        timerEl.textContent = remaining;

        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(function() {
            remaining--;
            timerEl.textContent = remaining;
            if (remaining <= 0) {
                clearInterval(timerInterval);
                if (!hasAnswered) disableButtons();
            }
        }, 1000);
    }

    function submitAnswer(option) {
        if (hasAnswered) return;
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            alert('Aloqa uzildi. Qayta urinib ko\'ring.');
            return;
        }
        
        hasAnswered = true;
        const timeTaken = (Date.now() - questionStartTime) / 1000;
        disableButtons();

        ws.send(JSON.stringify({
            action: 'submit_answer',
            player_id: playerId,
            selected_option: option,
            time_taken: timeTaken,
        }));

        const btn = document.querySelector('[data-option="' + option + '"]');
        if (btn) btn.style.transform = 'scale(1.02)';
    }

    function disableButtons() {
        document.querySelectorAll('.player-btn').forEach(function(btn) {
            btn.classList.add('disabled');
        });
    }

    function showFeedback(data) {
        if (timerInterval) clearInterval(timerInterval);

        const feedbackEl = document.getElementById('feedback');
        totalScore = data.total_score || 0;
        document.getElementById('player-score').textContent = totalScore + ' ball';

        if (data.is_correct) {
            consecutiveCorrect++;
            feedbackEl.className = 'feedback correct';
            feedbackEl.innerHTML = '‚úì To\'g\'ri!<br><small>+' + (data.points_earned || 0) + ' ball</small><br><small>' + (data.rank || 0) + '-o\'rin</small>';
            if (consecutiveCorrect >= 3) {
                showOnFire();
            }
        } else {
            consecutiveCorrect = 0;
            feedbackEl.className = 'feedback incorrect';
            feedbackEl.innerHTML = '‚úó Xato<br><small>' + (data.rank || 0) + '-o\'rin</small>';
        }
        feedbackEl.style.display = 'block';
        document.getElementById('game-state').style.display = 'none';
        document.getElementById('waiting-state').style.display = 'block';
        document.getElementById('timer').textContent = '--';

        setTimeout(function() {
            feedbackEl.style.display = 'none';
        }, 2500);
    }

    function showOnFire() {
        const el = document.getElementById('on-fire-overlay');
        if (!el) return;
        el.style.display = 'flex';
        setTimeout(function() {
            el.style.display = 'none';
        }, 2500);
    }

    function showPodium(podium) {
        consecutiveCorrect = 0;
        document.getElementById('waiting-state').style.display = 'none';
        document.getElementById('game-state').style.display = 'none';
        document.getElementById('feedback').style.display = 'none';
        document.getElementById('podium-container').style.display = 'block';

        const avatarEmojis = ['üòÄ', 'üòé', 'ü§ì', 'üò∫', 'ü¶ä', 'üê∂', 'üê±', 'ü¶Å', 'üêº', 'üê∏', 'ü¶Ñ', 'üê≤', 'ü§ñ', 'üëΩ', 'üéÉ'];
        const podiumEl = document.getElementById('podium');
        const order = [1, 0, 2];
        const classes = ['silver', 'gold', 'bronze'];
        const places = ['ü•à', 'ü•á', 'ü•â'];

        let html = '';
        order.forEach(function(idx, i) {
            if (podium[idx]) {
                const p = podium[idx];
                const emoji = avatarEmojis[(p.avatar_id || 1) - 1] || 'üòÄ';
                html += '<div class="podium-place">' +
                    '<div style="font-size: 3rem;">' + emoji + '</div>' +
                    '<div class="podium-bar ' + classes[i] + '">' + places[i] + '</div>' +
                    '<div class="podium-name">' + (p.nickname || '') + '</div>' +
                    '<div class="podium-score">' + (p.score || 0) + ' ball</div></div>';
            }
        });
        podiumEl.innerHTML = html;
    }

    // WebSocket-ni boshlash
    initWebSocket();

    // Sahifa yopilayotganda WebSocket-ni yopish
    window.addEventListener('beforeunload', function() {
        if (ws) {
            ws.close();
        }
    });
</script>
<!-- Ixtiyoriy: fon musiqasi uchun static/kahoot/bg-music.mp3 qo'shing va quyidagi qatorni uncomment qiling -->
<!-- <script>document.addEventListener('DOMContentLoaded', function(){ var a=document.getElementById('bg-music'); if(a) a.src='/static/kahoot/bg-music.mp3'; });</script> -->
{% endblock %}