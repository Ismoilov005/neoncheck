{% extends 'quizzes/base.html' %}

{% block title %}My Dashboard{% endblock %}

{% block content %}
<h1 style="margin-bottom: clamp(1.5rem, 3vw, 2rem);">My Dashboard</h1>

<div class="grid-proportional" style="margin-bottom: clamp(2rem, 4vw, 3rem);">
    <div class="card-proportional">
        <h3 style="color: var(--accent-emerald); margin-bottom: clamp(0.5rem, 1vw, 0.75rem);">Tests Taken</h3>
        <p style="font-size: clamp(2rem, 4vw, 3rem); font-weight: 700;">{{ total_taken }}</p>
    </div>
    
    <div class="card-proportional">
        <h3 style="color: var(--accent-emerald); margin-bottom: clamp(0.5rem, 1vw, 0.75rem);">Average Score</h3>
        <p style="font-size: clamp(2rem, 4vw, 3rem); font-weight: 700;">{{ avg_score }}%</p>
    </div>
</div>

{% if results %}
<h2 style="margin-bottom: clamp(0.85rem, 1.7vw, 1.28rem);">Performance Analytics</h2>
<div class="card-proportional" style="margin-bottom: clamp(1.7rem, 3.4vw, 2.55rem);">
    <canvas id="progressChart" style="max-height: clamp(213px, 34vw, 340px);"></canvas>
</div>
{% endif %}

<h2 style="margin-bottom: clamp(1rem, 2vw, 1.5rem);">Available Tests</h2>
<div class="grid-proportional">
    {% for test in available_tests %}
    <div class="card-proportional">
        <h3 style="margin-bottom: clamp(0.5rem, 1vw, 0.75rem); color: var(--accent-emerald);">
            {{ test.title }}
        </h3>
        <p style="color: var(--text-secondary); margin-bottom: clamp(0.75rem, 1.5vw, 1rem); font-size: clamp(0.875rem, 0.9rem + 0.3vw, 1rem);">
            {{ test.description|truncatewords:20 }}
        </p>
        <div style="display: flex; gap: clamp(0.5rem, 1vw, 0.75rem); flex-wrap: wrap; margin-bottom: clamp(0.75rem, 1.5vw, 1rem);">
            <span style="padding: clamp(0.25rem, 0.5vw, 0.5rem) clamp(0.5rem, 1vw, 0.75rem); background: var(--bg-tertiary); border-radius: clamp(0.25rem, 0.5vw, 0.375rem); font-size: clamp(0.75rem, 0.8rem + 0.3vw, 0.875rem);">
                {{ test.questions.count }} Questions
            </span>
            <span style="padding: clamp(0.25rem, 0.5vw, 0.5rem) clamp(0.5rem, 1vw, 0.75rem); background: var(--bg-tertiary); border-radius: clamp(0.25rem, 0.5vw, 0.375rem); font-size: clamp(0.75rem, 0.8rem + 0.3vw, 0.875rem); color: var(--text-secondary);">
                by {{ test.creator.username }}
            </span>
        </div>
        <a href="{% url 'test_take' test.id %}" class="btn-proportional btn-primary" style="width: 100%; text-align: center; text-decoration: none; display: block;">
            Take Test
        </a>
    </div>
    {% empty %}
    <div class="card-proportional" style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary);">
        <p>No tests available at the moment.</p>
    </div>
    {% endfor %}
</div>

{% if results %}
<h2 style="margin-top: clamp(2rem, 4vw, 3rem); margin-bottom: clamp(1rem, 2vw, 1.5rem);">Recent Results</h2>
<div class="card-proportional">
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 1px solid var(--border-color);">
                    <th style="padding: clamp(0.75rem, 1.5vw, 1rem); text-align: left;">Test</th>
                    <th style="padding: clamp(0.75rem, 1.5vw, 1rem); text-align: left;">Score</th>
                    <th style="padding: clamp(0.75rem, 1.5vw, 1rem); text-align: left;">Percentage</th>
                    <th style="padding: clamp(0.75rem, 1.5vw, 1rem); text-align: left;">Date</th>
                </tr>
            </thead>
            <tbody>
                {% for result in results %}
                <tr style="border-bottom: 1px solid var(--border-color);">
                    <td style="padding: clamp(0.75rem, 1.5vw, 1rem);">{{ result.test.title }}</td>
                    <td style="padding: clamp(0.75rem, 1.5vw, 1rem);">{{ result.score }}/{{ result.total_questions }}</td>
                    <td style="padding: clamp(0.75rem, 1.5vw, 1rem); color: var(--accent-emerald); font-weight: 600;">
                        {{ result.percentage|floatformat:1 }}%
                    </td>
                    <td style="padding: clamp(0.75rem, 1.5vw, 1rem); color: var(--text-secondary);">
                        {{ result.completed_at|date:"M d, Y H:i" }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    {% if results %}
    const ctx = document.getElementById('progressChart');
    if (ctx) {
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ chart_labels|safe }},
                datasets: [{
                    label: 'Score %',
                    data: {{ chart_scores|safe }},
                    borderColor: '#00ff00', // Neon green
                    backgroundColor: 'rgba(0, 255, 0, 0.1)',
                    borderWidth: 3,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#00ff00',
                    pointBorderColor: '#10b981',
                    pointBorderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    shadowOffsetX: 0,
                    shadowOffsetY: 0,
                    shadowBlur: 10,
                    shadowColor: 'rgba(0, 255, 0, 0.5)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        labels: {
                            color: '#a0a0a0',
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(26, 26, 26, 0.9)',
                        titleColor: '#10b981',
                        bodyColor: '#e5e5e5',
                        borderColor: '#10b981',
                        borderWidth: 1,
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return 'Score: ' + context.parsed.y + '%';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            color: '#a0a0a0',
                            font: {
                                size: 11
                            }
                        },
                        grid: {
                            color: 'rgba(16, 185, 129, 0.1)',
                            lineWidth: 1
                        }
                    },
                    x: {
                        ticks: {
                            color: '#a0a0a0',
                            font: {
                                size: 10
                            },
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: {
                            color: 'rgba(16, 185, 129, 0.1)',
                            lineWidth: 1
                        }
                    }
                }
            }
        });
        
        // Add glow effect to the line
        const originalDraw = chart.draw;
        chart.draw = function() {
            const ctx = this.canvas.getContext('2d');
            ctx.shadowBlur = 15;
            ctx.shadowColor = 'rgba(0, 255, 0, 0.6)';
            originalDraw.apply(this);
        };
    }
    {% endif %}
</script>
{% endblock %}
