{% extends 'quizzes/base.html' %}

{% block title %}Take Test: {{ test.title }}{% endblock %}

{% block extra_css %}
<style>
    /* Test sahifasi uchun yumshoqroq fon */
    body.test-page {
        --bg-primary: #0f0f0f;
        --bg-secondary: rgba(30, 30, 30, 0.85);
        --bg-tertiary: rgba(45, 45, 45, 0.7);
    }

    /* ========== IXCHAM STICKY HEADER ========== */
    #test-sticky-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 200;
        background: rgba(20, 20, 20, 0.95);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    /* Progress bar: 3px, eng tepada */
    #test-progress-bar {
        height: 3px;
        background: rgba(255,255,255,0.1);
        width: 100%;
    }
    #test-progress-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #10b981, #06b6d4);
        transition: width 0.3s ease;
    }

    /* Timer + Submit bir qatorda */
    #test-controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 16px;
        max-width: 1020px;
        margin: 0 auto;
        gap: 12px;
    }

    /* Test nomi (ixcham) */
    #test-title-compact {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 40%;
    }

    /* O'rta qism: progress foiz */
    #test-progress-text {
        font-size: 0.75rem;
        color: var(--text-secondary);
        background: rgba(255,255,255,0.05);
        padding: 4px 10px;
        border-radius: 10px;
    }

    /* Timer (ixcham) */
    #timer-compact {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
    #timer-display {
        font-size: 1.1rem;
        font-weight: 700;
        font-family: 'Courier New', monospace;
        color: #10b981;
        min-width: 50px;
    }
    #timer-display.warning { color: #f59e0b; }
    #timer-display.danger { color: #ef4444; }

    /* Submit tugma (ixcham) */
    #submit-btn-compact {
        padding: 6px 16px;
        font-size: 0.8rem;
        background: linear-gradient(135deg, #10b981, #06b6d4);
        color: #0f0f0f;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.2s ease;
    }
    #submit-btn-compact:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    /* ========== ASOSIY KONTENT ========== */
    #test-main-content {
        padding-top: 56px; /* Sticky header uchun joy */
        max-width: 800px;
        margin: 0 auto;
    }

    /* Test sarlavhasi */
    #test-intro {
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    #test-intro h1 {
        font-size: 1.5rem;
        margin-bottom: 8px;
        color: var(--text-primary);
    }
    #test-intro p {
        color: var(--text-secondary);
        font-size: 0.9rem;
        line-height: 1.5;
    }

    /* Savol kartasi */
    .question-card {
        background: var(--bg-secondary);
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 8px;
        padding: 20px 24px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .question-card:hover {
        border-color: rgba(16, 185, 129, 0.2);
    }

    .question-number {
        font-size: 0.8rem;
        color: #10b981;
        font-weight: 600;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .question-text {
        font-size: 1.05rem;
        line-height: 1.6;
        color: var(--text-primary);
        margin-bottom: 16px;
    }

    /* Variantlar */
    .options-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .option-label {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        background: var(--bg-tertiary);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.95rem;
        line-height: 1.5;
    }
    .option-label:hover {
        background: rgba(255,255,255,0.08);
        border-color: rgba(255,255,255,0.15);
    }
    .option-label input[type="radio"] {
        margin-right: 12px;
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #10b981;
    }
    .option-label .answer-indicator {
        margin-left: auto;
        font-weight: 600;
        display: none;
    }

    /* Javob ko'rsatilganda (neon effekt kamaytirilgan) */
    .answer-correct {
        border-color: rgba(16, 185, 129, 0.5) !important;
        background: rgba(16, 185, 129, 0.1) !important;
    }
    .answer-incorrect {
        border-color: rgba(239, 68, 68, 0.5) !important;
        background: rgba(239, 68, 68, 0.1) !important;
    }
    .answer-correct-revealed {
        border-color: rgba(16, 185, 129, 0.4) !important;
        background: rgba(16, 185, 129, 0.08) !important;
    }

    /* ========== BACK TO TOP ========== */
    #back-to-top {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 100;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(16, 185, 129, 0.8);
        color: #0f0f0f;
        border: none;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        opacity: 0.7;
        transition: opacity 0.2s, transform 0.2s;
    }
    #back-to-top:hover {
        opacity: 1;
        transform: translateY(-2px);
    }
    #back-to-top.visible { display: flex; }

    /* ========== MOBIL ========== */
    @media (max-width: 640px) {
        #test-controls { padding: 6px 12px; gap: 8px; }
        #test-title-compact { display: none; }
        #test-main-content { padding-top: 48px; }
        .question-card { padding: 16px; }
        .option-label { padding: 10px 14px; font-size: 0.9rem; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Ixcham Sticky Header -->
<div id="test-sticky-header">
    <div id="test-progress-bar">
        <div id="test-progress-fill"></div>
    </div>
    <div id="test-controls">
        <span id="test-title-compact">{{ test.title|truncatechars:30 }}</span>
        <span id="test-progress-text">0%</span>
        {% if test.time_limit %}
        <div id="timer-compact">
            <span>⏱</span>
            <span id="timer-display">00:00</span>
        </div>
        {% endif %}
        <button type="submit" form="testForm" id="submit-btn-compact">Submit</button>
    </div>
</div>

<!-- Asosiy kontent -->
<div id="test-main-content">
    <div style="margin-bottom: 16px;">
        <a href="{% url 'user_dashboard' %}" style="color: var(--text-secondary); text-decoration: none; font-size: 0.85rem;">
            ← Back to Dashboard
        </a>
    </div>

    <div id="test-intro">
        <h1>{{ test.title }}</h1>
        {% if test.description %}
        <p>{{ test.description }}</p>
        {% endif %}
    </div>

    <form id="testForm">
        {% csrf_token %}
        <div id="questions-container">
            {% for question in questions %}
            <div class="question-card" data-question-id="{{ question.id }}">
                <div class="question-number">Savol {{ forloop.counter }} / {{ questions|length }}</div>
                <p class="question-text">{{ question.text }}</p>
                <div class="options-container">
                    {% for option in question.shuffled_options %}
                    <label class="option-label"
                           data-option-id="{{ option.id }}"
                           data-question-id="{{ question.id }}">
                        <input type="radio"
                               name="question_{{ question.id }}"
                               value="{{ option.id }}"
                               data-question-id="{{ question.id }}"
                               data-option-id="{{ option.id }}">
                        <span>{{ option.text }}</span>
                        <span class="answer-indicator"></span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </form>
</div>

<!-- Back to Top (kichik, yarim shaffof) -->
<button type="button" id="back-to-top" title="Yuqoriga" aria-label="Yuqoriga">↑</button>

<!-- Test Completion Modal -->
<div id="completionModal" class="modal">
    <div class="modal-content">
        <h2 style="margin-bottom: clamp(1rem, 2vw, 1.5rem); text-align: center;">Test Completed!</h2>
        <div id="scoreDisplay" style="text-align: center; margin-bottom: clamp(1.5rem, 3vw, 2rem);">
            <p style="font-size: clamp(1.5rem, 3vw, 2.5rem); font-weight: 700; color: var(--accent-emerald); margin-bottom: clamp(0.5rem, 1vw, 0.75rem);">
                <span id="scoreText"></span>%
            </p>
            <p style="color: var(--text-secondary);">
                You scored <span id="correctCount"></span> out of <span id="totalCount"></span>
            </p>
        </div>
        <div style="display: flex; gap: clamp(0.75rem, 1.5vw, 1rem); justify-content: center;">
            <button id="saveResultBtn" class="btn-proportional btn-primary">Save to History</button>
            <button id="skipSaveBtn" class="btn-proportional btn-secondary">Skip</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Yumshoqroq fon uchun body classini qo'shish
    document.body.classList.add('test-page');

    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    let testData = {
        answers: {},
        startTime: null,
        timeSpent: 0
    };

    // Timer functionality
    let timerInterval = null;
    let remainingSeconds = 0;
    const timerKey = 'test_timer_{{ test.id }}';
    const startTimeKey = 'test_start_time_{{ test.id }}';

    // Initialize timer
    function initTimer() {
        {% if test.time_limit %}
        const timeLimitMinutes = {{ test.time_limit }};
        const timeLimitSeconds = timeLimitMinutes * 60;

        // Check if timer exists in localStorage (for page refresh)
        const savedStartTime = localStorage.getItem(startTimeKey);
        if (savedStartTime) {
            const elapsedSeconds = Math.floor((Date.now() - parseInt(savedStartTime)) / 1000);
            remainingSeconds = Math.max(0, timeLimitSeconds - elapsedSeconds);
            testData.startTime = parseInt(savedStartTime);
        } else {
            remainingSeconds = timeLimitSeconds;
            testData.startTime = Date.now();
            localStorage.setItem(startTimeKey, testData.startTime.toString());
        }

        // Start timer
        updateTimerDisplay();
        timerInterval = setInterval(() => {
            remainingSeconds--;
            updateTimerDisplay();

            if (remainingSeconds <= 0) {
                clearInterval(timerInterval);
                localStorage.removeItem(timerKey);
                localStorage.removeItem(startTimeKey);
                alert('Time is up! Your test is being submitted automatically.');
                submitTest(true); // Auto-submit
            } else {
                localStorage.setItem(timerKey, remainingSeconds.toString());
            }
        }, 1000);
        {% endif %}
    }

    function updateTimerDisplay() {
        const timerDisplay = document.getElementById('timer-display');
        if (!timerDisplay) return;

        const minutes = Math.floor(remainingSeconds / 60);
        const seconds = remainingSeconds % 60;
        timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

        // Change color when time is running out (neon effektsiz)
        timerDisplay.classList.remove('warning', 'danger');
        if (remainingSeconds <= 60) {
            timerDisplay.classList.add('danger');
        } else if (remainingSeconds <= 300) {
            timerDisplay.classList.add('warning');
        }
    }

    // Initialize timer on page load
    initTimer();

    /**
     * Clear all styles, classes, and indicators from a question's options
     */
    function clearQuestionStyles(questionId) {
        const questionCard = document.querySelector(`.question-card[data-question-id="${questionId}"]`);
        if (!questionCard) return;

        const optionLabels = questionCard.querySelectorAll('.option-label');
        optionLabels.forEach(label => {
            label.classList.remove('answer-correct', 'answer-incorrect', 'answer-correct-revealed');
            // CSS ga qaytarish (inline style emas)
            label.style.borderColor = '';
            label.style.boxShadow = '';
            label.style.background = '';

            const indicator = label.querySelector('.answer-indicator');
            if (indicator) {
                indicator.textContent = '';
                indicator.style.display = 'none';
                indicator.style.color = '';
            }
        });
    }

    /**
     * Apply correct answer styling
     */
    function applyCorrectStyling(optionLabel) {
        optionLabel.classList.add('answer-correct');
        const indicator = optionLabel.querySelector('.answer-indicator');
        if (indicator) {
            indicator.textContent = '✓';
            indicator.style.color = '#10b981';
            indicator.style.display = 'inline';
        }
    }

    /**
     * Apply incorrect answer styling and reveal correct answer
     */
    function applyIncorrectStyling(optionLabel, correctOptionId) {
        optionLabel.classList.add('answer-incorrect');
        const indicator = optionLabel.querySelector('.answer-indicator');
        if (indicator) {
            indicator.textContent = '✗';
            indicator.style.color = '#ef4444';
            indicator.style.display = 'inline';
        }

        // Highlight correct answer if provided
        if (correctOptionId) {
            const correctLabel = document.querySelector(`[data-option-id="${correctOptionId}"]`);
            if (correctLabel) {
                correctLabel.classList.add('answer-correct-revealed');
                const correctIndicator = correctLabel.querySelector('.answer-indicator');
                if (correctIndicator) {
                    correctIndicator.textContent = '✓ Correct';
                    correctIndicator.style.color = '#10b981';
                    correctIndicator.style.display = 'inline';
                }
            }
        }
    }

    /**
     * Check answer via AJAX
     */
    function checkAnswer(questionId, optionId) {
        // Clear all previous styles for this question first
        clearQuestionStyles(questionId);

        fetch('/api/check-answer/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ option_id: optionId })
        })
        .then(response => response.json())
        .then(data => {
            const optionLabel = document.querySelector(`[data-option-id="${optionId}"]`);
            if (!optionLabel) return;

            if (data.is_correct) {
                // Mark selected option as correct
                applyCorrectStyling(optionLabel);
            } else {
                // Mark selected option as incorrect and reveal correct answer
                applyIncorrectStyling(optionLabel, data.correct_option_id);
            }
        })
        .catch(error => {
            console.error('Error checking answer:', error);
            // Optionally show error message to user
        });
    }

    // Progress bar: real-time foiz yangilash
    function updateProgressBar() {
        const total = document.querySelectorAll('.question-card').length;
        const answered = Object.keys(testData.answers).length;
        const pct = total ? Math.round((answered / total) * 100) : 0;
        const fill = document.getElementById('test-progress-fill');
        const label = document.getElementById('test-progress-text');
        if (fill) fill.style.width = pct + '%';
        if (label) label.textContent = answered + '/' + total + ' (' + pct + '%)';
    }

    // Back to Top: scroll da ko'rsatish/yashirish
    const backToTopBtn = document.getElementById('back-to-top');
    if (backToTopBtn) {
        window.addEventListener('scroll', function() {
            backToTopBtn.classList.toggle('visible', window.scrollY > 400);
        });
        backToTopBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }

    // Handle option selection and real-time checking
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const questionId = this.dataset.questionId;
            const optionId = this.dataset.optionId;

            // Update test data
            testData.answers[questionId] = parseInt(optionId);
            updateProgressBar();

            // Always check answer via AJAX when selection changes
            checkAnswer(questionId, parseInt(optionId));
        });
    });

    // Boshlang'ich progress
    updateProgressBar();

    // Handle form submission
    document.getElementById('testForm').addEventListener('submit', function(e) {
        e.preventDefault();

        // Check if all questions are answered
        const totalQuestions = document.querySelectorAll('.question-card').length;
        const answeredQuestions = Object.keys(testData.answers).length;

        if (answeredQuestions < totalQuestions) {
            if (!confirm(`You have only answered ${answeredQuestions} out of ${totalQuestions} questions. Submit anyway?`)) {
                return;
            }
        }

        submitTest(false);
    });

    function submitTest(saveToHistory) {
        // Clear timer
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        localStorage.removeItem(timerKey);
        localStorage.removeItem(startTimeKey);

        // Calculate time spent
        if (testData.startTime) {
            testData.timeSpent = Math.floor((Date.now() - testData.startTime) / 1000);
        }

        fetch(`/test/{{ test.id }}/submit/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                answers: testData.answers,
                save_to_history: saveToHistory,
                time_spent: testData.timeSpent
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {

                // ✅ Sertifikat huquqi bo'lsa — sertifikat sahifasiga yo'naltirish (keyin Download)
                if (data.can_get_certificate && data.result_id) {
                    window.location.href = `/certificate/${data.result_id}/`;
                    return;
                }

                if (saveToHistory) {
                    // Already saved, redirect to dashboard
                    window.location.href = "{% url 'user_dashboard' %}";
                } else {
                    // Show modal with results for first submission
                    document.getElementById('scoreText').textContent = data.percentage;
                    document.getElementById('correctCount').textContent = data.score;
                    document.getElementById('totalCount').textContent = data.total;
                    document.getElementById('completionModal').classList.add('active');

                    // Handle save button
                    document.getElementById('saveResultBtn').onclick = function() {
                        this.disabled = true;
                        this.textContent = 'Saving...';
                        submitTest(true);
                    };

                    // Handle skip button
                    document.getElementById('skipSaveBtn').onclick = function() {
                        document.getElementById('completionModal').classList.remove('active');
                        setTimeout(() => {
                            window.location.href = "{% url 'user_dashboard' %}";
                        }, 500);
                    };
                }
            } else {
                alert('Error submitting test: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error submitting test:', error);
            alert('Error submitting test. Please try again.');
        });
    }
</script>
{% endblock %}
